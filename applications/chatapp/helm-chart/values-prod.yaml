# =========================================
# ChatApplication - Production Values (AWS EKS)
# =========================================

# Global settings (accessible to all subcharts via .Values.global)
global:
  dockerhubSecretName: dockerhub-secret
  namespace: chatapp-prod

# =========================================
# BACKEND SUBCHART
# =========================================
backend:
  enabled: true
  replicaCount: 2
  
  image:
    repository: tomernos/connecthub-backend
    tag: 83e1341
    pullPolicy: Always
  
  privateRepository:
    enabled: true
    secretName: dockerhub-secret
  
  serviceAccount:
    create: false
    name: "chatapp-sa"
  
  # Enable AWS Secrets Manager integration
  secretsProvider:
    enabled: true
    className: "chatapp-secrets"
  
  initContainers:
    - name: wait-for-postgres
      image: busybox:1.36
      command:
        - 'sh'
        - '-c'
        - |
          echo "Waiting for PostgreSQL..."
          until nc -z chatapp-postgres 5432; do sleep 2; done
          echo "PostgreSQL ready!"
  
  env:
    FLASK_APP: run.py
    FLASK_ENV: production
    DB_HOST: chatapp-postgres
    DB_PORT: "5432"
    DB_NAME: chatapp
    DB_USER: chatuser
    REDIS_HOST: chatapp-redis
    REDIS_PORT: "6379"
    RABBITMQ_HOST: chatapp-rabbitmq
    RABBITMQ_PORT: "5672"
    RABBITMQ_USER: guest
  
  envFrom:
    - secretRef:
        name: backend-secret
  
  # Production resource limits
  resources:
    requests:
      memory: 256Mi
      cpu: 200m
    limits:
      memory: 512Mi
      cpu: 500m
  
  # Health checks for production
  livenessProbe:
    enabled: true
    httpGet:
      path: /health
      port: 5000
    initialDelaySeconds: 30
    periodSeconds: 10
  
  readinessProbe:
    enabled: true
    httpGet:
      path: /ready
      port: 5000
    initialDelaySeconds: 10
    periodSeconds: 5
  
  monitoring:
    enabled: false  # Disable in production if not using Prometheus

# =========================================
# FRONTEND SUBCHART
# =========================================
frontend:
  enabled: true
  replicaCount: 2
  
  image:
    repository: tomernos/connecthub-frontend
    tag: 83e1341
    pullPolicy: Always
  
  env:
    API_URL: http://chatapp-backend:5000
    BACKEND_URL: http://chatapp-backend:5000  # For nginx.conf proxy_pass substitution
    NODE_ENV: production
  
  resources:
    requests:
      memory: 128Mi
      cpu: 100m
    limits:
      memory: 256Mi
      cpu: 200m

# =========================================
# REDIS SUBCHART
# =========================================
redis:
  enabled: true
  replicaCount: 1
  
  image:
    repository: redis
    tag: "7-alpine"
    pullPolicy: IfNotPresent
  
  persistence:
    enabled: false
  
  resources:
    requests:
      memory: 128Mi
      cpu: 100m
    limits:
      memory: 256Mi
      cpu: 200m

# =========================================
# POSTGRES SUBCHART
# =========================================
postgres:
  enabled: true
  replicaCount: 1
  
  image:
    repository: postgres
    tag: "16-alpine"
    pullPolicy: IfNotPresent
  
  env:
    POSTGRES_DB: chatapp
    POSTGRES_USER: chatuser
    PGDATA: /var/lib/postgresql/data/pgdata
  
  envFrom:
    - secretRef:
        name: postgres-secret
  
  secretsProvider:
    enabled: true
    className: "chatapp-secrets"
    volumeName: "secrets-store-inline"
  
  persistence:
    enabled: false
  
  resources:
    requests:
      memory: 128Mi
      cpu: 100m
    limits:
      memory: 256Mi
      cpu: 200m

# =========================================
# RABBITMQ SUBCHART
# =========================================
rabbitmq:
  enabled: true
  replicaCount: 1
  
  image:
    repository: rabbitmq
    tag: "3-management-alpine"
    pullPolicy: IfNotPresent
  
  env:
    RABBITMQ_DEFAULT_USER: guest
  
  envFrom:
    - secretRef:
        name: rabbitmq-secret
  
  secretsProvider:
    enabled: true
    className: "chatapp-secrets"
    volumeName: "secrets-store-inline"
  
  persistence:
    enabled: false
  
  resources:
    requests:
      memory: 256Mi
      cpu: 200m
    limits:
      memory: 512Mi
      cpu: 500m

# =========================================
# PARENT CHART RESOURCES
# (Shared resources, secrets, ingress)
# =========================================

secrets:
  backend: {}
  postgres: {}
  rabbitmq: {}
  
  dockerhub:
    enabled: true
    secretName: "dockerhub-secret"
    config: "eyJhdXRocyI6eyJodHRwczovL2luZGV4LmRvY2tlci5pby92MS8iOnsidXNlcm5hbWUiOiJ0b21lcm5vcyIsInBhc3N3b3JkIjoiZGNrcl9wYXRfc3lmV2RoM3hxdTlkWG90RGFtUnoxdU1TYmhRIiwiZW1haWwiOiJ0b21lcm5vczFAZW1haWwuY29tIiwiYXV0aCI6ImRHOXRaWEp1YjNNNlpHTnJjbDl3WVhSZmMzbG1WMlJvTTNoeGRUbGtXRzkwUkdGdFVub3hkVTFUWW1oUiJ9fX0="

# SecretProviderClass (AWS Secrets Manager - ENABLED for production)
secretProviderClasses:
  chatapp-secrets:
    enabled: true
    provider: aws
    parameters:
      region: "eu-central-1"
      usePodIdentity: "true"
      objects:
        - objectName: "chatapp/secret-key"
          objectType: "secretsmanager"
          objectAlias: "SECRET_KEY"
        - objectName: "chatapp/db-password"
          objectType: "secretsmanager"
          objectAlias: "DB_PASSWORD"
        - objectName: "chatapp/rabbitmq-password"
          objectType: "secretsmanager"
          objectAlias: "RABBITMQ_PASSWORD"
    secretObjects:
      - secretName: backend-secret
        type: Opaque
        data:
          - objectName: "SECRET_KEY"
            key: "SECRET_KEY"
          - objectName: "DB_PASSWORD"
            key: "DB_PASSWORD"
          - objectName: "RABBITMQ_PASSWORD"
            key: "RABBITMQ_PASSWORD"
      - secretName: postgres-secret
        type: Opaque
        data:
          - objectName: "DB_PASSWORD"
            key: "POSTGRES_PASSWORD"
      - secretName: rabbitmq-secret
        type: Opaque
        data:
          - objectName: "RABBITMQ_PASSWORD"
            key: "RABBITMQ_DEFAULT_PASS"

# ServiceAccounts (Pod Identity)
serviceAccounts:
  chatapp-sa:
    enabled: true
    annotations: {}

# Ingress
ingress:
  enabled: true
  className: nginx
  
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-http01  
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
  
  # Hosts array - supports multiple hosts (scalable, modular, reusable)
  hosts:
<<<<<<< HEAD
    - host: chatapp-prod.tomernos.xyz
=======
    - host: chatapp-prod.tomernos.xyz  
>>>>>>> 2120b560fc3e5909870b207c2ee07f76f8101760
      paths:
        - path: /api
          pathType: Prefix
          serviceName: chatapp-backend
          servicePort: 5000
        - path: /
          pathType: Prefix
          serviceName: chatapp-frontend
          servicePort: 80
    # Example: Add more hosts as needed (e.g., separate API domain, CDN)
    # - host: api.tomernos.xyz
    #   paths:
    #     - path: /
    #       pathType: Prefix
    #       serviceName: chatapp-backend
    #       servicePort: 5000
  
  # TLS - hosts will be automatically collected from ingress.hosts if not specified
  tls:
    - secretName: chatapp-tls
<<<<<<< HEAD
      # hosts: []  # Empty = use all hosts from ingress.hosts (automatic)



# =========================================
# SECRET PROVIDER CLASSES - AWS Secrets Manager
# =========================================
secretProviderClasses:
  chatapp-secrets:
    enabled: true  # Enable SecretProviderClass in production
    provider: aws
    parameters:
      region: "eu-central-1"  # Your AWS region
      usePodIdentity: "true"  # Uses EKS Pod Identity
      objects:
        - objectName: "chatapp/secret-key"
          objectType: "secretsmanager"
        - objectName: "chatapp/db-password"
          objectType: "secretsmanager"
        - objectName: "chatapp/rabbitmq-password"
          objectType: "secretsmanager"
    
    # Create Kubernetes Secret from AWS secrets
    secretObjects:
      - secretName: backend-secret
        type: Opaque
        data:
          - objectName: "chatapp/secret-key"
            key: "SECRET_KEY"
          - objectName: "chatapp/db-password"
            key: "DB_PASSWORD"
          - objectName: "chatapp/rabbitmq-password"
            key: "RABBITMQ_PASSWORD"

# =========================================
# ServiceAccounts - Pod Identity for AWS
# =========================================
serviceAccounts:
  chatapp-sa:
    enabled: true
    annotations: {}  
 
=======
      hosts:
        - chatapp-prod.tomernos.xyz
>>>>>>> 2120b560fc3e5909870b207c2ee07f76f8101760
