# =========================================
# Backend Subchart - Default Values
# =========================================

enabled: true
replicaCount: 2

image:
  repository: tomernos/connecthub-backend
  tag: "83e1341"
  pullPolicy: Always

# Private repository authentication
privateRepository:
  enabled: true
  secretName: dockerhub-secret

# Service configuration
service:
  type: ClusterIP
  port: 5000
  targetPort: 5000

# Service account (for AWS Pod Identity)
serviceAccount:
  create: false
  name: "chatapp-sa"  # Use existing SA with Pod Identity

# Init containers
initContainers:
  - name: wait-for-postgres
    image: busybox:1.36
    command:
      - 'sh'
      - '-c'
      - |
        echo "Waiting for PostgreSQL to be ready..."
        until nc -z postgres 5432; do
          echo "PostgreSQL is unavailable - sleeping"
          sleep 2
        done
        echo "PostgreSQL is up - starting backend"

# Environment variables
env:
  FLASK_APP: run.py
  FLASK_ENV: production
  # OpenTelemetry configuration for distributed tracing
  OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector-opentelemetry-collector.monitoring.svc.cluster.local:4317"
  OTEL_SERVICE_NAME: "chatapp-backend"
  OTEL_SERVICE_NAMESPACE: "chatapp-prod"  # Overridden per environment in values-{env}.yaml
  DB_HOST: postgres
  DB_PORT: "5432"
  DB_NAME: chatapp
  DB_USER: chatuser
  REDIS_HOST: redis
  REDIS_PORT: "6379"
  RABBITMQ_HOST: rabbitmq
  RABBITMQ_PORT: "5672"
  RABBITMQ_USER: guest

# Secrets - loaded from Kubernetes Secret (created by SecretProviderClass)
envFrom:
  - secretRef:
      name: backend-secret

# AWS Secrets Manager integration (optional, enabled in prod)
secretsProvider:
  enabled: false
  className: ""  # Will be set in values-prod.yaml

# Resource limits
resources:
  requests:
    memory: 128Mi
    cpu: 100m
  limits:
    memory: 256Mi
    cpu: 200m

# Health probes
livenessProbe:
  enabled: false
  httpGet:
    path: /health
    port: 5000
  initialDelaySeconds: 30
  periodSeconds: 10

readinessProbe:
  enabled: false
  httpGet:
    path: /ready
    port: 5000
  initialDelaySeconds: 10
  periodSeconds: 5

# Monitoring configuration
monitoring:
  enabled: true
  scrapeInterval: 15s  # How often Prometheus scrapes metrics
  scrapeTimeout: 10s   # Timeout for each scrape

nodeSelector: {}
tolerations: []
affinity: {}
